include:
  - project: 'strmprivacy/tools-and-utilities/ci-templates'
    file: '/nodejs/base.yml'
  - project: 'strmprivacy/tools-and-utilities/ci-templates'
    file: '/nodejs/publish.yml'
  - project: 'strmprivacy/tools-and-utilities/ci-templates'
    file: '////common/google-application-credentials.yml'

generate-typescript:
  stage: generate
  image: namely/protoc-all:latest
  before_script:
    - apt-get install -y make unzip
    # Ensure that the protoc compiler has the Google protos
    - make default-google-dependencies
  script:
    - make typescript-generate
  artifacts:
    paths:
      - lang/typescript
  needs:
    - buf-lint
    - aip-guidelines-lint
    - breaking
  except:
    - master

.typescript-needs:
  stage: publish
  needs:
    - generate-typescript
  dependencies:
    - generate-typescript

typescript-artifact-build:
  extends:
    - .typescript-needs
    - .nodejs-without-artifact-registry-creds
    - .google-artifact-registry-credentials
  script:
    - make typescript-build
  only:
    - /^renovate\/build-only.*$/

typescript-artifact-snapshot:
  extends:
    - .typescript-needs
    - .nodejs-artifact-snapshot
  script:
    - make typescript-publish-snapshot

typescript-artifact-release:
  extends:
    - .typescript-needs
    - .nodejs-artifact-release
  script:
    - make typescript-publish-release
